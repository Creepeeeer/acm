## çŒ«æ ‘

æ™®é€šçº¿æ®µæ ‘çš„å»ºæ ‘è¿‡ç¨‹æ˜¯$O(n)$çš„ï¼ŒæŸ¥è¯¢å•æ¬¡æ˜¯$O(logn)$çš„

çŒ«æ ‘è§£å†³çš„é—®é¢˜æ˜¯**æ ‘ä¸å­˜åœ¨ä¿®æ”¹æ“ä½œ**ï¼Œå¹¶ä¸”æŸ¥è¯¢çš„ä¿¡æ¯æ˜¯**èƒ½è¢«å·¦å³ä¸¤ä¸ªåŒºé—´çš„ä¿¡æ¯åˆå¹¶çš„**ï¼Œ**å¯æ”¯æŒåœ¨çº¿æŸ¥è¯¢**ï¼Œå»ºæ ‘è¿‡ç¨‹æ˜¯$O(nlogn)$,å•æ¬¡æŸ¥è¯¢æ˜¯O(1)çš„

åŸç†ï¼š

åœ¨æŸ¥è¯¢ [ğ‘™,ğ‘Ÿ]![[l,r]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) è¿™æ®µåŒºé—´çš„ä¿¡æ¯å’Œçš„æ—¶å€™ï¼Œå°†çº¿æ®µæ ‘æ ‘ä¸Šä»£è¡¨ [ğ‘™,ğ‘™]![[l,l]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„èŠ‚ç‚¹å’Œä»£è¡¨ [ğ‘Ÿ,ğ‘Ÿ]![[r,r]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) è¿™æ®µåŒºé—´çš„èŠ‚ç‚¹åœ¨çº¿æ®µæ ‘ä¸Šçš„ LCA æ±‚å‡ºæ¥ï¼Œè®¾è¿™ä¸ªèŠ‚ç‚¹ ğ‘![p](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) ä»£è¡¨çš„åŒºé—´ä¸º [ğ¿,ğ‘…]![[L,R]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)ï¼Œæˆ‘ä»¬ä¼šå‘ç°ä¸€äº›éå¸¸æœ‰è¶£çš„æ€§è´¨ï¼š

1. [ğ¿,ğ‘…]![[L,R]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) è¿™ä¸ªåŒºé—´ä¸€å®šåŒ…å« [ğ‘™,ğ‘Ÿ]![[l,r]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)ã€‚æ˜¾ç„¶ï¼Œå› ä¸ºå®ƒæ—¢æ˜¯ ğ‘™![l](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„ç¥–å…ˆåˆæ˜¯ ğ‘Ÿ![r](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„ç¥–å…ˆã€‚
2. [ğ‘™,ğ‘Ÿ]![[l,r]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) è¿™ä¸ªåŒºé—´ä¸€å®šè·¨è¶Š [ğ¿,ğ‘…]![[L,R]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„ä¸­ç‚¹ã€‚ç”±äº ğ‘![p](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) æ˜¯ ğ‘™![l](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) å’Œ ğ‘Ÿ![r](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„ LCAï¼Œè¿™æ„å‘³ç€ ğ‘![p](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„å·¦å„¿å­æ˜¯ ğ‘™![l](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„ç¥–å…ˆè€Œä¸æ˜¯ ğ‘Ÿ![r](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„ç¥–å…ˆï¼Œğ‘![p](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„å³å„¿å­æ˜¯ ğ‘Ÿ![r](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„ç¥–å…ˆè€Œä¸æ˜¯ ğ‘™![l](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„ç¥–å…ˆã€‚å› æ­¤ï¼Œğ‘™![l](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) ä¸€å®šåœ¨ [ğ¿,mid]![[L,\mathit{mid}]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) è¿™ä¸ªåŒºé—´å†…ï¼Œğ‘Ÿ![r](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) ä¸€å®šåœ¨ (mid,ğ‘…] è¿™ä¸ªåŒºé—´å†…ã€‚

**å®ç°ï¼š**

ä¸åŒäºä¼ ç»Ÿçº¿æ®µæ ‘åœ¨è¿™ä¸ªèŠ‚ç‚¹é‡Œåªä¿ç•™ [ğ‘™,ğ‘Ÿ]![[l,r]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„å’Œï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªèŠ‚ç‚¹é‡Œé¢é¢å¤–ä¿å­˜ (ğ‘™,mid]çš„åç¼€å’Œæ•°ç»„å’Œ (mid,ğ‘Ÿ]çš„å‰ç¼€å’Œæ•°ç»„ã€‚

è¿™æ ·çš„è¯å»ºæ ‘çš„å¤æ‚åº¦ä¸º ğ‘‡(ğ‘›) =2ğ‘‡(ğ‘›/2) +ğ‘‚(ğ‘›) =ğ‘‚(ğ‘›logâ¡ğ‘›)![T(n)=2T(n/2)+O(n)=O(n\log{n})](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) åŒç†ç©ºé—´å¤æ‚åº¦ä¹Ÿä»åŸæ¥çš„ ğ‘‚(ğ‘›)![O(n)](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) å˜æˆäº† ğ‘‚(ğ‘›logâ¡ğ‘›)![O(n\log{n})](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)ã€‚

å¦‚æœæˆ‘ä»¬è¯¢é—®çš„åŒºé—´æ˜¯ [ğ‘™,ğ‘Ÿ]![[l,r]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) é‚£ä¹ˆæˆ‘ä»¬æŠŠä»£è¡¨ [ğ‘™,ğ‘™]![[l,l]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„èŠ‚ç‚¹å’Œä»£è¡¨ [ğ‘Ÿ,ğ‘Ÿ]![[r,r]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„èŠ‚ç‚¹çš„ LCA æ±‚å‡ºæ¥ï¼Œè®°ä¸º ğ‘![p](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)ã€‚

æ ¹æ®åˆšæ‰çš„ä¸¤ä¸ªæ€§è´¨ï¼Œğ‘™,ğ‘Ÿ![l,r](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) åœ¨ ğ‘![p](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) æ‰€åŒ…å«çš„åŒºé—´ä¹‹å†…å¹¶ä¸”ä¸€å®šè·¨è¶Šäº† ğ‘![p](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„ä¸­ç‚¹ã€‚

è¿™æ„å‘³è¿™ä¸€ä¸ªéå¸¸å…³é”®çš„äº‹å®æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ğ‘![p](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) é‡Œé¢çš„å‰ç¼€å’Œæ•°ç»„å’Œåç¼€å’Œæ•°ç»„ï¼Œå°† [ğ‘™,ğ‘Ÿ]![[l,r]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) æ‹†æˆ [ğ‘™,mid] +(mid,ğ‘Ÿ]ä»è€Œæ‹¼å‡ºæ¥ [ğ‘™,ğ‘Ÿ]![[l,r]](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) è¿™ä¸ªåŒºé—´ã€‚

æˆ‘ä»¬å°†è¿™ä¸ªåºåˆ—è¡¥æˆ 2çš„æ•´æ¬¡å¹‚ï¼Œç„¶åå»ºçº¿æ®µæ ‘ï¼Œæ­¤æ—¶æˆ‘ä»¬å‘ç°èŠ‚ç‚¹[l,l]å’ŒèŠ‚ç‚¹[r,r]çš„lcaçš„ç¼–å·å°±æ˜¯ä¸¤ä¸ªèŠ‚ç‚¹äºŒè¿›åˆ¶ç¼–å·çš„æœ€é•¿å…¬å…±å‰ç¼€ LCPã€‚å¯å‘ç°å‘ç°åœ¨ ğ‘¥![x](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) å’Œ ğ‘¦![y](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„äºŒè¿›åˆ¶ä¸‹ `lcp(x,y)=x>>digits[x^y]`ã€‚ï¼ˆå…¶ä¸­ `digits[x]` è¡¨ç¤ºäºŒè¿›åˆ¶ä¸‹ ğ‘¥![x](data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7) çš„ä½æ•°ï¼Œå³ âŒŠ$log2(ğ‘¥)$âŒ‹ +1)



ä¾‹é¢˜:

[P6240 å¥½åƒçš„é¢˜ç›® - æ´›è°·](https://www.luogu.com.cn/problem/P6240)

åŒºé—´1->n,æ¯ä¸ªä½ç½®æ˜¯ä¸€ä¸ªç‰©å“ä»·å€¼ä¸ºvï¼Œé‡é‡ä¸ºwï¼Œqæ¬¡è¯¢é—®ï¼Œæ±‚åªé€‰l.....rä¹‹é—´ç‰©å“çš„01èƒŒåŒ…æœ€å¤§ä»·å€¼

ç»™ä½ ä¸¤ä¸ªåŒºé—´çš„01èƒŒåŒ…ï¼Œåˆå¹¶ä¸¤ä¸ª01èƒŒåŒ…ï¼Œè®¡ç®— $\max\limits_{i=0}^{s} F1[i] + F2[s - i]$ å³å¯ã€‚è¿™æ ·ä»…éœ€ $O(t)$ã€‚

æ€»æ—¶é—´å¤æ‚åº¦$O(ntlogn+qt)$ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯$O(ntlogn)$

```c++
pii ob[N+1];
int n,q;
vector<vector<int>>pre[8*N+1],suf[8*N+1];
int num[N+1];//num[i]è¡¨ç¤ºç‚¹iåœ¨çŒ«æ ‘ä¸­çš„ç¼–å·
inline int digit(int x){
    return x==0?x:32-__builtin_clz(x);
}//digit(i)è¡¨ç¤ºiçš„äºŒè¿›åˆ¶çš„ä½æ•°=floor(log2(i))+1
struct tree{
    int l,r;
}tr[4*N+1];
void build(int i,int l,int r){
    if(l>n)return;
    tr[i].l=l;
    tr[i].r=r;
    int m=(l+r)>>1;
    suf[i].resize(m-l+2);
    pre[i].resize(r-m+1);
    for(int j=0;j<suf[i].size();j++)suf[i][j].resize(201);
    for(int j=0;j<pre[i].size();j++)pre[i][j].resize(201);
    for(int j=m+1;j<=min(r,n);j++){
        auto&[w,v]=ob[j];
        for(int k=0;k<=200;k++){
            pre[i][j-m][k]=pre[i][j-m-1][k];
            if(k>0)pre[i][j-m][k]=max(pre[i][j-m][k],pre[i][j-m][k-1]);
            if(k>=w&&j<=n)pre[i][j-m][k]=max(pre[i][j-m][k],pre[i][j-m-1][k-w]+v);
        }
    }
    for(int j=min(n,m);j>=l;j--){
        auto&[w,v]=ob[j];
        for(int k=0;k<=200;k++){
            suf[i][m-j+1][k]=suf[i][m-j][k];
            if(k>0)
            suf[i][m-j+1][k]=max(suf[i][m-j+1][k],suf[i][m-j+1][k-1]);
            if(k>=w&&j<=n)
            suf[i][m-j+1][k]=max(suf[i][m-j+1][k],suf[i][m-j][k-w]+v);
        }
    }
    if(l==r){
        num[l]=i;
        return;
    }
    else{
        build(i<<1,l,m);
        build(i<<1|1,m+1,r);
    }
}
//main
    cin>>n>>q;
    for(int i=1;i<=n;i++){
        cin>>ob[i].first;
    }
    for(int i=1;i<=n;i++){
        cin>>ob[i].second;
    }
    build(1,1,1<<((int)ceil(log2(n))));
    while(q--){
        int l,r,t;
        cin>>l>>r>>t;
        int lca=num[l]>>digit(num[l]^num[r]);
        int an=0;
        int m=(tr[lca].l+tr[lca].r)>>1;
        auto&ve1=suf[lca][m+1-l],&ve2=pre[lca][r-m];
        for(int i=0;i<=t;i++){
            an=max(an,ve1[i]+ve2[t-i]);
        }
        cout<<an<<'\n';
    }
```



## çŒ«æ ‘åˆ†æ²»

å…¶å®åˆšæ‰é‚£ä¸ªé¢˜ä½¿ç”¨çŒ«æ ‘æ˜¯è§£å†³ä¸äº†çš„å› ä¸ºç©ºé—´ä¼šçˆ†

çŒ«æ ‘åˆ†æ²»æ€»æ—¶é—´å¤æ‚åº¦$O(ntlogn+qt)$ï¼ˆå’ŒçŒ«æ ‘ä¸€æ ·ï¼‰ï¼Œä½†ç©ºé—´å¤æ‚åº¦æ˜¯$O(nt)$ï¼Œ

çŒ«æ ‘å¯ä»¥**åœ¨çº¿**ï¼Œä½†æ˜¯çŒ«æ ‘åˆ†æ²»æ˜¯**ç¦»çº¿æŸ¥è¯¢**ï¼ŒäºŒè€…éƒ½ä¸å¯ä»¥ä¿®æ”¹æ ‘

**å®ç°ï¼š**

å› ä¸ºæ˜¯ç¦»çº¿æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªäºŒç»´çš„dpè¡¨å°±å¯ä»¥ï¼Œå¹¶ä¸”å·²ç»ä¸éœ€è¦å°†ç‚¹è¡¥å…¨ä¸º2çš„å¹‚æ¬¡

å¸¦ç€l,rå’Œæ»¡è¶³å½“å‰åŒºé—´çš„Qèµ°ï¼Œå°†Qåˆ†ä¸ºä¸‰ç±»ï¼š[L..m-1),[m+1....r],è·¨è¶Šmçš„ï¼Œå»ºå‡ºæœ¬è½®[l...r]çš„dpè¡¨ï¼ˆç›´æ¥åœ¨åŸæ¥è¡¨ä¸Šè¦†ç›–å³å¯ï¼‰ï¼Œç¬¬ä¸€ç±»å’Œç¬¬äºŒç±»çš„ç»§ç»­é€’å½’ä¸‹å»ï¼Œç¬¬ä¸‰ç±»çš„åˆ©ç”¨æœ¬è½®äº§ç”Ÿçš„dpè¡¨ç›´æ¥è§£å†³

```c++
int n,q;
int an[M+1];
struct Q
{
    int l,r,k,id;
};
pii ob[N+1];
int pre[N+1][T+1],suf[N+1][T+1];
void solve(int l,int r,vector<Q>&ve){
    if(l==r){
        for(auto&[ql,qr,k,id]:ve){
            if(k>=ob[l].first)an[id]=ob[l].second;
        }
        return;
    }
    int m=(l+r)>>1;
    for(int i=m;i<=r;i++){
        for(int j=0;j<=T;j++){
            pre[i][j]=0;
        }
    }
    for(int i=m+1;i<=r;i++){
        auto&[w,v]=ob[i];
        for(int j=1;j<=T;j++){
            pre[i][j]=max(pre[i-1][j],pre[i][j-1]);
            if(j>=w)pre[i][j]=max(pre[i][j],pre[i-1][j-w]+v);
        }
    }
    for(int i=m+1;i>=l;i--){
        for(int j=0;j<=T;j++){
            suf[i][j]=0;
        }
    }
    for(int i=m;i>=l;i--){
        auto&[w,v]=ob[i];
        for(int j=1;j<=T;j++){
            suf[i][j]=max(suf[i+1][j],suf[i][j-1]);
            if(j>=w)suf[i][j]=max(suf[i][j],suf[i+1][j-w]+v);
        }
    }
    vector<Q>ve1,ve2;
    for(auto&x:ve){
        auto[l,r,k,id]=x;
        if(r<m)ve1.push_back(x);
        else if(l>=m+1)ve2.push_back(x);
        else{
            for(int j=0;j<=k;j++){
                an[id]=max(an[id],pre[r][j]+suf[l][k-j]);
            }
        }
    }
    solve(l,m,ve1);
    solve(m+1,r,ve2);
}
signed main()
{
    ios::sync_with_stdio(false);
    cin.tie(0), cout.tie(0);
    cin>>n>>q;
    for(int i=1;i<=n;i++)cin>>ob[i].first;
    for(int i=1;i<=n;i++)cin>>ob[i].second;
    vector<Q>ve(q);
    for(int i=0;i<q;i++){
        cin>>ve[i].l>>ve[i].r>>ve[i].k;
        ve[i].id=i;
    }
    solve(1,n,ve);
    for(int i=0;i<q;i++){
        cout<<an[i]<<'\n';
    }
```

